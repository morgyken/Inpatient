<div class="panel panel-info">
    <div class="panel-heading">
        Prescriptions Table
    </div>
    <div class="panel-body">
        <table class="table table-stripped table-condensed" id="prescribed_drugs">
            <thead>
                <th>Drug</th>
                <th>Prescription</th>
                <th>Prescribed</th>
                <th>Dispensed</th>
                <th>Status</th>
                <th>Remaining</th>
                <th>Administered</th>
                <th>Actions</th>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div class="row">
            <div class="col-md-12" id="save-prescription">
                <button class="col-md-2 btn btn-primary btn-sm" data-toggle="modal" data-target="#administer-modal">
                    Administer Drugs
                </button>   
            </div>
        </div>
    </div>
    
    @include('inpatient::admissions.evaluation.includes.administer_drugs_modal')

    <!-- Stop drug modal -->
    <div id="stop-modal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Stop Drug</h4>
                </div>
                <div class="modal-body">
                    {!! Form::open(['id'=>'stop-drug-form']) !!}
                        <div class="form-group">
                            <label id="prescription-name"></label>
                            <input id="prescription-id" name="prescriptionId" type="hidden" class="form-control" />
                        </div>

                        <div class="form-group">
                            <label for="">Reason</label>
                            <textarea name="stop_reason" type="text" class="form-control" rows="5"></textarea>
                        </div>

                    {!! Form::close()!!}
                </div>
                <div class="modal-footer">
                    <button id="confirm-stop" type="button" class="btn btn-info">Confirm</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End of drug modal -->
    
    
    <script>
        var PRESCRIPTIONS_ENDPOINT = "{{ url('inpatient/evaluations/'.$visit->id.'/prescriptions') }}";
        
        $(document).ready(function(){
            $('#prescribed_drugs').dataTable({
                'ajax': {
                    'url': PRESCRIPTIONS_ENDPOINT,
                },
            });

            // Note that this action button is generated by the datatable - backend - for the time being :) im on a deadline   
            $('body').on('click', '.stop-drug', function(e){
                
                let prescription = JSON.parse(e.target.value);

                $('#prescription-name').html(prescription.drug);

                $('#prescription-id').val(prescription.id);

                $('#stop-modal').modal();

            });

            $('body').on('click', '#confirm-stop', function(){

                let data = $('#stop-drug-form').serialize();

                $.post(CANCEL_PRESCRIPTION_ENDOINT, data, function(){
                    
                    $('#confirm-stop').hide();

                }).done(function(){

                    alertify.success("Drug cancelled successfully");
                    $('#confirm-stop').show();
                    $('#stop-modal').modal('hide');
                    $('#prescribed_drugs').dataTable().api().ajax.reload();

                }).fail(function(){

                    alertify.error("Something went wrong");
                    $('#confirm-stop').show();
                    $('#stop-modal').modal('hide');

                });
            });
        });
    </script>
</div>